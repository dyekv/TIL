## DiSセミナー（AWS Cloud Watch）

### Cloud Watch の概要

できること

- EC2の死活監視→CloudWatch Metrics
- リソース監視（CPU/メモリ使用率）→CloudWatch Metrics
- ログ監視→CloudWatch Logs
- 障害時のアクション（メール通知・再起動など）→CloudWatch Alarm
- サービス不提供時間帯のサーバ停止→CloudWatch Events

![スクリーンショット 2021-02-09 13 08 41](https://user-images.githubusercontent.com/56820273/107314440-f1ab9980-6ad7-11eb-8405-1899fcd82815.png)


### CloudWatch Metrics

メトリクスとはシステムのパフォーマンスに関するデータ

多くのサービスでリソースの無料メトリクスを提供している

メトリクス・名前空間・ディメンション・統計という４つの要素で構成されている

- メトリクス
  - 監視対象の変数（EC2のメモリ使用率、EC2のCPU使用率など）
  - 作成されたリージョンのみに存在する
- 名前空間
  - メトリクスを集約したコンテナ
  - CloudWatchのエントリポイントには名前空間を設定する必要がある
- ディメンション
  - メトリクスを一位に識別する名前・値のペア
- 統計
  - 指定期間のメトリクスデータの集計
  - 様々な統計方法が利用可能（Minimun,Maximun,Sumなど）
  - Metrics Math を使用することで、数式を使った独自集計も可能
  
メトリクスは標準で１分ごとに生成される
カスタムメトリクスの高解像度を利用すれば最短で１秒毎にメトリクスが生成される

メトリクスデータの保存期間は解像度によって決まる
１分未満：３時間
１分〜：１５日など

メトリクスデータの取得可能なサービスは現在96種類

メトリクスの収集について

EC2が提供しているメトリクスはこれらの種類がある

![スクリーンショット 2021-02-09 13 20 06](https://user-images.githubusercontent.com/56820273/107315189-88c52100-6ad9-11eb-906f-efc1b9abb2f9.png)

カスタムメトリクスは標準メトリクスで収集できないメトリクス

AWSCLIの`put-metric-data`などのAPIを実行することで独自のメトリクスを登録可能

データ欠落時の処理を設定できる（通信不良が問題のとき、評価を制限できる）

### CloudWatch Alarm

管理者にメール・EC2の再起動・インスタンスの増減（AutoScaling）などのアクションを実行させることができる

![スクリーンショット 2021-02-09 13 29 36](https://user-images.githubusercontent.com/56820273/107315855-dc843a00-6ada-11eb-83ef-fa6f2ca7c89f.png)

AWSCLIの`cloudwatch set-alarm-state`でアクションのテストが可能

### CloudWatch Logs

EC2のアクセスログを取得できる

収集先はS3に設定することもできる（Lambda関数を使う必要がある）

メトリクスフィルターを用い、メトリクスに変換することも可能、そこからアラームを動かすこともできる

保存期間を１日〜無制限で選択できる（無制限だとログがたまりコストがかかる）

ロググループ/ログストリーム/ログイベント の階層で保存される

ログイベントが最小単位、タイムスタンプと生のイベントメッセージで構成

メトリクスフィルタはロググループに割り当てられる

フィルタに一致するとメトリクスに変換など（正規表現は使用できない）

### CloudWatch Events

サービスのステータスが変化したときにアクションを行いたいときに使用する

AWSリソースの変更を示すイベントのストリームを提供（EC2が停止中→実行中に変わったときなど）

cron式を使い、定時実行も可能（0 14 * * ? *）など

ルールでイベントを検出し、ターゲットに振り分ける（ターゲットは複数設定可能）

ターゲットはルールで指定したJSON形式のイベントを受け取り処理する

![スクリーンショット 2021-02-09 13 50 16](https://user-images.githubusercontent.com/56820273/107317308-bf9d3600-6add-11eb-843b-735f57d2578a.png)

### その他の機能

![スクリーンショット 2021-02-09 13 56 49](https://user-images.githubusercontent.com/56820273/107317784-aa74d700-6ade-11eb-80f2-41f5dd05554b.png)

![スクリーンショット 2021-02-09 13 58 22](https://user-images.githubusercontent.com/56820273/107317885-e14aed00-6ade-11eb-8294-34a66611703b.png)








